[TOC]

# 越狱环境搭建

查看是否可以越狱 http://jailbreak.25pp.com/ios

## Cydia安装软件

1. 添加软件源
2. 进入软件源，添加软件，安装
3. 有时需要重启SpringBoard

## 必备软件

安装补丁 **Apple File Conduit2，Apple Sync Unified，iFile，爱思助手**

Mac上的App：**iFunBox，爱思助手**

两个常用软件源 **apt.saurik.com  apt.25pp.com**

通过Cydia安装的软件是*deb格式*的，通过爱思助手安装的软件是*ipa格式*的

如果Cydia安装失败，可以从网络上下载deb格式，并把它拖到 **/var/root/Media/Cydia/AutoInstall** 下,重启就会自动安装了

## 效率软件

Alfred，Go2Shell，iTerm2，ExtraFinder

## 远程登录

通过ssh 登录已经越狱后的手机，需要**手机安装open SSH**，并且电脑和手机处于相同的局域网下，

**有root($HOME/var/root)和mobile($HOME/var/mobile)两个用户，初始密码是alpine**

**passwd 修改用户的密码**

查看ssh的版本，*客户端查看 /etc/ssh/ssh_config, 服务端查看 /etc/ssh/sshd_config 查看他们的Protocol字段*

通过命令  `ssh root@IP地址`登录

### SSH通信过程

1. 建立安全连接

   - 链接过程中，服务端会提供身份证明(公钥+其他信息)

   - 如果已经登录过服务器，客户端会把服务器的公钥信息保存到 **~/.ssh/known_hosts** 中

   - 更改保存的公钥信息

     - 打开客户端的 known_hosts 文件删除服务器的公钥

     - 使用 `ssh-keygen -R 服务器IP地址`

2. 客户端认证

   - 密码认证：
   - 秘钥认证(默认，如果认证不了才考虑密码认证)
     - 在客户端生成公钥和私钥  **ssh-keygen**，默认使用RSA生成，可以使用-t指定密钥类型
       - 公钥位于 ~/.ssh/id_rsa.pub
       - 私钥位于 ~/.ssh/id_rsa
     - 把客户端的公钥内容追加到服务器的授权文件(~/.ssh/authorized_keys) 尾部, 使用**ssh-copy-id root@服务器地址**
     - 也可以使用scp命令将公钥copy到一个文件夹，然后通过cat file.name >> authorized_keys中
     - ` chomd755 ~, chmod 755 ~/.ssh, chmod 644 ~/.ssh/autorized_keys`

3. 数据传输

### 使用USB进行SSH登录

通过usbmuxd这个自启动服务来将数据通过USB传给iPhone,位于 /System/Library/PrivateFrameworks/MobileDevice.framework/Resources/usbmuxd

### usbmuxd使用

下载usbmuxed包(1.0.8版本) http://cgit.sukuimashita.com/usbmuxd.git/snapshot/usbmuxd-1.0.8.tar.gz

将服务器的22映射到10010端口，`python2 tcprelay.py -t 22:10010`

也可以使用iproxy代理 `iproxy 10010 22` https://www.liangqili.com/myGitbook/_book/articles/iOS/iosre/03_usbmuxd.html

端口映射完毕后，如果想和服务器的22通信，就只需要和本地的10010通信即可 `ssh root@localhost -p 10010`

如果上面的命令不管用，可以使用 `ssh root@127.0.0.1 -p 10010`

# Cycript使用 http://www.cycript.org/

### 基本使用：支持OC++,ES6,Java等的混合物，可以调试修改Mac/iOS App

1. 在手机上安装Cycript
2. ssh root@手机ip，输入cycript -p 进程名称
3. 安装adv-cmds，使用ps查看所有进程或者通过 `ps -A | grep 关键词`

#### 常用语法

- UIApp 等价于 [UIApplication sharedApplication]

- 定义变量 `var app = UIApp.keyWindow`

- 通过内存地址获取变量  **#地址**

- `ObjectiveC.classes` 获取所有已加载的类
- 获取对象的所有成员 ***变量**
- 递归打印所有子控件（跟LLDB一样的函数）**UIapp.keyWindow.recursiveDescription().toString()**
- 筛选某种类型的对象 **choose(UIViewController)**

将库copy到远程 `scp -P 10010 mjcript.cy root@127.0.0.1:/usr/lib/cycript0.9/mjscript.cy`

#### 封装cy

@import 文件名。 如果不写exports.sum，此时sum默认是全局的

exports将函数封装到了文件名中，exports参数名固定，用于向外提供接口

可以放到cycript0.9下面，按照域名倒序的文件下，此时需要使用 `@import com.mj.test`;引入

### Reveal & Lookin

环境配置

在iPhone上安装RevealLoader。添加源：apt.so/codermjlee

点击设置，找到Reveal，选择调试的App

将Reveal的iOS Library下的RevealServer拖到到手机的/Library/RHRevealLoader/RevealLoader

#### Ipa安装

上传AppStore，通过itunes，通过Xcode

# 逆向App的思路

## 界面分析，通过Cycript或者Reveal或者Lookin

## 代码分析

1. 静态分析：MachOView，class-dump，Hopper disammber，ida

   - ### Class-dump：dump出MachO的头文件

     - 下载 stevengard.com/projects/class-dump
     - 下载完后，复制到/usr/local/bin，这样可以在命令行使用
     - `class-dump -H MachO文件路径 -o 头文件存放目录` 结合sublimetext进行搜索查看

   - ### Hopper：将MachO文件的机器代码反编译成汇编或OC伪代码或Swift代码

   - ### dsc（dyld shared cache）

     - 系统库共享缓存路径 */System/Library/Caches/com.apple.dyld/dyld_shared_cache_arm**X***
     - 通过dyld(动态链接编辑器)加载，/usr/lib/dyld，源码位于 https://opensource.apple.com/tarballs/dyld
     - dyld加载过程
       - load->loadPhrase1->loadPhrase2->loadPhrase4->loadPhrase5->findInSharedCacheImage->
     - 抽取动态库，使用dsc_extractor
       1. 下载 https://opensource.apple.com/tarballs/dyld
       2. 将dyld3/shared-cache/dsc_extarctor.cpp代码里面的#if 0 改成 #if 1，然后删除其他的无用代码
       3. 编译`/usr/bin/clang++  dsc_extractor.cpp -o dsc_extractor`
       4. 将dsc_extractor移动到下载的共享缓存库dyld所在的目录下
       5. 执行 `./dsc_extractor 缓存文件路径  指定输出的文件夹`
       6. 执行完成，进入System/Library/Frameworks即可看到抽取出来的framework

   - #### Mach-O：Mac/iOS上用于存储程序、库的标准格式

     - 可以在xnu源码(https://opensource.apple.com/tarballs/xnu) 查看Mach-O格式的详细定义
     - 常见的Mach-O文件
       - MH_OBJECT：目标文件（.o），静态库文件（N个.o合并在一起）
       - MH_EXECUTE：可执行文件
       - MH_DYLIB：动态库文件.dylib,.framework/xx
       - MH_DYLINKER：动态链接编辑器 /usr/lib/dyld
       - MH_DSYM：存储二进制文件符号 ./dSYM/Contents/Resources/DWARF/xx
     - file 命令查看文件格式
     - find .  name  *.a 查看当前目录下的.a后缀的文件

2. 动态调试：debugServer，LLDB

## 代码编写

1. 注入代码到App
2. 必要时重新重新签名，打包ipa





















